<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">
 var theme = 'bootstrap';
 $("#optionsExpander").jqxExpander({ width: '100%', theme: theme,  expanded: false});
 //$("#dateRange").jqxCalendar({ width: 220, height: 220,  selectionMode: 'range' });
 
</script>

<script type="text/javascript">

     
     
     param = '{{ param }}'
     
     
     var today = new Date(Date.now());
     $("#fromdate").jqxDateTimeInput({width: '200px', height: '25px', theme: theme, formatString: "yyyy-MM-dd",value: new Date(new Date(today).setMonth(today.getMonth()-1))});
     $("#todate").jqxDateTimeInput({width: '200px', height: '25px', theme: theme, formatString: "yyyy-MM-dd",value: today });

     
     $("#fromdate").on('change', function (event) {
                    fromdate= $('#fromdate').jqxDateTimeInput('getText'); 
                });
     $("#todate").on('change', function (event) {
                    todate= $('#todate').jqxDateTimeInput('getText'); 
                });        
        
      $("#searchkeywordsfield").jqxInput({placeHolder: "Keywords", height: 25, width: 200, minLength: 1});          
                
      $("#filterButton").jqxButton({ width: '200'});
      $("#filterButton").on('click', function () {          
                     
                  drawChart(fromdate,todate,searchkeywords);
                  $('#detailsarea').html('');
                });
     var fromdate = $('#fromdate').jqxDateTimeInput('getText');
     var todate = $('#todate').jqxDateTimeInput('getText');
     var searchkeywords= $('#searchkeywordsfield').val();
     
     if (param!=''){
        //alert(param);
        $('#searchkeywordsfield').val(param);
        $('#fromdate').jqxDateTimeInput({ value: new Date(2000, 0, 1) });
        $('#todate').jqxDateTimeInput({ value: new Date(2015, 0, 1) });
        searchkeywords=param;
     }
     
     
     
     
     function drawChart(from,to,searchkeywords) {
      searchkeywords= $('#searchkeywordsfield').val();
      var params = {"fromdate": from, "todate": to, "searchkeywords": searchkeywords};
      var jsonData = $.ajax({
          url: "jobs_applications_statistics_getdata",
          dataType:"json",
          type: "POST",
          data: JSON.stringify(params),
          async: false
          }).responseText;
	
	
	
	
          jqwdata = JSON.parse(jsonData);
          jqwdata.shift();
	  
	   var cellclass = function (row, columnfield, value) {
                if (value == 0) {
                    return 'red';
                }
               
                else return 'green';
            }
	  
	  var source =
	  
            { localdata : jqwdata,
              datafields: [ 
                    { name: 'Employer Name', type: 'string', map: '0'},
                    { name: 'Employer Email', type: 'string', map: '1'},
                    { name: 'Job ID', type: 'int', map: '2'},
                    { name: 'Job Title', type: 'string', map: '3'},
                    { name: 'Job Posted At', type: 'date', map: '4'},
                    { name: 'Budget', type: 'float', map: '5'},
                    { name: 'Application Count', type: 'int', map: '6'},
                    { name: 'Shortlisted Applications', type: 'int', map: '7'},
                    { name: 'Applicants Msgs', type: 'int', map: '8'},
                    { name: 'Employers Responses', type: 'int', map: '9'},
                    { name: 'Proposal Count', type: 'int', map: '10'},
                    { name: 'Accepted Proposals', type: 'int', map: '11'},
                    { name: 'Status', type: 'string', map: '12'},                    
                    ],
                datatype: "array"
            };
            var joblinkrenderer = function (row, column, value) {                                
                var html = "<a href='http://www.nabbesh.com/admin/contracts/job/"+value+"' target=_blank>"+ value+ "</a>";
                return html;
            }
            var dataAdapter = new $.jqx.dataAdapter(source);
            $("#jqwtablearea").jqxGrid(
            {
                width: '100%',
                height: '100%',
                source: dataAdapter,
                columnsresize: true,
                sortable: true,
                showfilterrow: true,
                filterable: true,
                altrows: true,
                columns: [
                  { text: 'Employer Name', datafield: 'Employer Name', filtertype: 'textbox', pinned: true, width:100},
                  { text: 'Employer Email', datafield: 'Employer Email', filtertype: 'textbox', width:100},
                  { text: 'Job ID', datafield: 'Job ID', filtertype: 'number', cellsrenderer: joblinkrenderer},
                  { text: 'Job Title', datafield: 'Job Title', filtertype: 'textbox'},
                  { text: 'Job Posted At', datafield: 'Job Posted At', filtertype: 'date'},
                  { text: 'Budget', datafield: 'Budget', filtertype: 'number'},
                  { text: 'Application Count', datafield: 'Application Count', filtertype: 'number', cellclassname: cellclass},
                  { text: 'Shortlisted Applications', datafield: 'Shortlisted Applications', filtertype: 'number', cellclassname: cellclass},
                  { text: 'Applicants Msgs', datafield: 'Applicants Msgs', filtertype: 'number', cellclassname: cellclass},
                  { text: 'Employers Responses', datafield: 'Employers Responses', filtertype: 'number', cellclassname: cellclass},
                  { text: 'Proposal Count', datafield: 'Proposal Count', filtertype: 'number', cellclassname: cellclass},
                  { text: 'Accepted Proposals', datafield: 'Accepted Proposals', filtertype: 'number', cellclassname: cellclass},                  
                  { text: 'Status', datafield: 'Status', filtertype: 'number'},
                ]
            });          
            //$("#jqwtablearea").jqxGrid('autoresizecolumns');
      
            $('#jqwtablearea').on('rowselect', function (event) 
		{
		    var args = event.args; 
		    var row = args.rowindex;
		    var cell = $('#jqwtablearea').jqxGrid('getcell', row, 'Job ID');	
		    drawCommunicationChart(cell.value.toString());
		});
      
      
      if(jsonData.length <=184){
        alert('Hoot! No results for your search');
      }
      else
      {
      var data = new google.visualization.arrayToDataTable($.parseJSON(jsonData));
	          
      
      
      var dataView = new google.visualization.DataView(data);
      

      var formatter = new google.visualization.ColorFormat();
      formatter.addRange(0, 1, '#000000', '#ffecff');
      formatter.addRange(1, 1000, '#000000', '#3DAA58');
      formatter.format(data, 7); 
      formatter.format(data, 7); 
      var formatter1 = new google.visualization.ColorFormat();
      formatter1.addRange(0, 1, '#000000', '#ffecff');
      formatter1.addRange(1, 1000, '#000000', '#3DAA95');
      formatter1.format(data, 10); 
      formatter1.format(data, 11); 
      var formatter3 = new google.visualization.ColorFormat();
      //formatter3.addRange(null,'Active', '#000000', '#ffecff');
      formatter3.addRange('Closed',null, '#fff', '#555555');
      formatter3.format(data, 12); 
      
      var formatter2 = new google.visualization.PatternFormat('<a href="http://www.nabbesh.com/admin/contracts/job/{0}"  target="_blank">{0}</a>');
      formatter2.format(data, [2],2);
            
      var tablearea = new google.visualization.Table(document.getElementById('tablearea'));
     
      function selectHandler() {
        var selection = tablearea.getSelection();
        var item = selection[0];
        var str = data.getValue(item.row, 2);
    
        drawCommunicationChart(str.toString());        
       
      }
      
      google.visualization.events.addListener(tablearea, 'select', selectHandler);
      
      var options = {'showRowNumber': true, 'allowHtml': true, 'height': '500px'};
      
      dataView.setColumns([0,1,2,3,4,5,6,8,9,10,11,12]);
      //tablearea.draw(dataView,options);
      
 
     }
      // Apply formatter to second column
    }
    
    
    
    
    
    
    
    
    
    function drawCommunicationChart(job_id)
    {
      //alert(job_id);
      var params = {"job_id": job_id};
      var jsonData = $.ajax({
          url: "jobs_communications_getdata",
          dataType:"json",
          type: "POST",
          data: JSON.stringify(params),
          async: false
          }).responseText;
        
      
       if(jsonData.length <=120){
          $('#detailsarea').html('');
      }
      else
      {
        //alert(jsonData); 
        var data = new google.visualization.arrayToDataTable($.parseJSON(jsonData));               
        var formatter1 = new google.visualization.ColorFormat();
        formatter1.addRange(0, 1, '#000000', '#ffecff');
        formatter1.addRange(1, 1000, '#000000', '#3DAA95');
        formatter1.format(data, 4); 
        formatter1.format(data, 5); 
        formatter1.format(data, 6); 
        formatter1.addRange(0, 1, '#000000', '#ffecff');
        formatter1.addRange(1, 1000, '#000000', '#3DAA95');
        formatter1.format(data, 3); 
        var formatter2 = new google.visualization.PatternFormat('<a href="http://www.nabbesh.com/contracts/workstream/{0}"  target="_blank">Go To Workflow:{0}</a>');
        formatter2.format(data, [2],2);
        
        
        var detailsarea = new google.visualization.Table(document.getElementById('detailsarea'));
        detailsarea.draw(data,{allowHtml: true});
        
      
      }
      
    }
    
    drawChart(fromdate,todate, searchkeywords);
    
</script>



 <div id='optionsExpander'>
            <div>Options</div>
            <div>
                <table>

                   <tr><td>From:</td><td><div style='margin-top: 10px; font-size: 13px; font-family: Verdana;' id='fromdate'></div></td></tr>
                   <tr><td>To:</td><td><div style='margin-top: 10px; font-size: 13px; font-family: Verdana;' id='todate'></div></td></tr> 
                   <tr><td>Search:</td><td><input type="text" id="searchkeywordsfield"/></td></tr>
                   <tr><td></td><td><div><input type="button" value="Filter Results" id='filterButton' /></div></td></tr>                                     
                </table>   
            </div>
        </div>


<div id="reportarea" style="padding: 20px 20px 20px 20px">
<div id="output"></div>
<div id="detailsarea" style="width: 100%; height:100%; float: left; padding: 10px 10px 10px 0px"></div>
<div id="tablearea" style="width: 100%; float: left;"></div>
<div id="jqwtablearea" style="width: 100%; height:100%; float: left;"></div>
</div>

<style>     
        .green {
            color: black\9;
            background-color: #ff00ff\9;
        }
        .yellow {
            color: black\9;
            background-color: yellow\9;
        }
        .red {
            color: black\9;
            background-color: #e83636\9;
        }
        .green:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected), .jqx-widget .green:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected) {
            color: black;
            background-color: #33AD33;
        }
        .yellow:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected), .jqx-widget .yellow:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected) {
            color: black;
            background-color: #FFFF80;
        }
        .red:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected), .jqx-widget .red:not(.jqx-grid-cell-hover):not(.jqx-grid-cell-selected) {
            color: black;
            background-color: #FFCCCC;
        }
</style>


